<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Panel sterowania</title>
</head>
<body>
  <h1>Panel sterowania</h1>

  <div id="loginDiv">
    <input id="password" type="password" placeholder="Hasło panelu" />
    <button onclick="login()">Zaloguj</button>
  </div>

  <div id="panelDiv" style="display:none;">
    <h2>Klienci</h2>
    <select id="clientsSelect" onchange="selectClient()"></select>

    <h2>Wysyłanie komendy</h2>
    <input id="commandInput" type="text" placeholder="Komenda do wysłania" />
    <button onclick="sendCommand()">Wyślij komendę</button>

    <h2>Otrzymany wynik</h2>
    <pre id="resultOutput">Brak wyniku</pre>

    <button onclick="getResult()">Odśwież wynik</button>
  </div>

  <script>
    let loggedIn = false;
    let selectedClient = null;

    async function login() {
      const password = document.getElementById('password').value;
      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      if (res.ok) {
        loggedIn = true;
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('panelDiv').style.display = 'block';
        loadClients();
      } else {
        alert('Błędne hasło!');
      }
    }

    async function loadClients() {
      if (!loggedIn) return alert('Zaloguj się najpierw!');
      const res = await fetch('/clients');
      const clients = await res.json();
      const select = document.getElementById('clientsSelect');
      select.innerHTML = '';
      clients.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        select.appendChild(option);
      });
      if (clients.length > 0) {
        selectedClient = clients[0];
      }
    }

    function selectClient() {
      const select = document.getElementById('clientsSelect');
      selectedClient = select.value;
      document.getElementById('resultOutput').textContent = 'Brak wyniku';
    }

    async function sendCommand() {
      if (!selectedClient) return alert('Wybierz klienta!');
      const command = document.getElementById('commandInput').value;
      if (!command) return alert('Wpisz komendę!');
      const res = await fetch('/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client: selectedClient, command })
      });
      if (res.ok) {
        alert('Komenda wysłana!');
        document.getElementById('commandInput').value = '';
      } else {
        alert('Błąd wysyłania komendy');
      }
    }

    async function getResult() {
      if (!selectedClient) return alert('Wybierz klienta!');
      const res = await fetch(`/result?client=${encodeURIComponent(selectedClient)}`);
      if (res.status === 200) {
        const text = await res.text();
        document.getElementById('resultOutput').textContent = text;
      } else {
        document.getElementById('resultOutput').textContent = 'Brak wyniku';
      }
    }
  </script>
</body>
</html>
