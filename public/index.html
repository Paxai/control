<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Panel sterowania</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #fileExplorer {
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
      max-width: 800px;
      background-color: #f9f9f9;
    }
    #fileList {
      list-style: none;
      padding-left: 0;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      background-color: white;
    }
    #fileList li {
      cursor: pointer;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    #fileList li:hover {
      background-color: #f0f0f0;
    }
    #fileList li.directory::before {
      content: "📁 ";
    }
    #fileList li.file::before {
      content: "📄 ";
    }
    #fileList li.file:hover::after {
      content: " 💾";
      float: right;
      color: #007bff;
    }
    #fileList li.up::before {
      content: "⬆️ ";
    }
    #fileContent {
      white-space: pre-wrap;
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 10px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    #currentPath {
      font-weight: bold;
      margin-bottom: 10px;
      padding: 5px;
      background-color: #e9e9e9;
      border-radius: 3px;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
    button {
      padding: 8px 12px;
      margin: 5px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    input, select {
      padding: 5px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <h1>Panel sterowania</h1>

  <div id="loginDiv">
    <input id="password" type="password" placeholder="Hasło panelu" />
    <button onclick="login()">Zaloguj</button>
  </div>

  <div id="panelDiv" style="display:none;">
    <h2>Klienci</h2>
    <select id="clientsSelect" onchange="selectClient()"></select>
    <button onclick="loadClients()">Odśwież listę klientów</button>
    <button onclick="openExplorer()">Otwórz eksplorator plików</button>

    <h2>Wysyłanie komendy</h2>
    <input id="commandInput" type="text" placeholder="Komenda do wysłania" style="width: 300px;" />
    <button onclick="sendCommand()">Wyślij komendę</button>

    <h2>Otrzymany wynik</h2>
    <pre id="resultOutput">Brak wyniku</pre>
    <button onclick="getResult()">Odśwież wynik</button>

    <hr />

    <h2>Eksplorator plików</h2>
    <div id="fileExplorer" style="display:none;">
      <div style="margin-bottom: 10px;">
        <input type="file" id="fileUpload" style="display:none;" onchange="uploadFile()" />
        <button onclick="document.getElementById('fileUpload').click()">📤 Prześlij plik</button>
        <span id="uploadStatus" style="margin-left: 10px; font-style: italic;"></span>
      </div>
      <div id="currentPath"></div>
      <div id="loadingIndicator" class="loading" style="display:none;">Ładowanie...</div>
      <ul id="fileList"></ul>
      <h3>Zawartość pliku:</h3>
      <pre id="fileContent">Wybierz plik, aby zobaczyć zawartość</pre>
    </div>
  </div>

  <script>
    let loggedIn = false;
    let selectedClient = null;
    let apiToken = null;

    async function login() {
      const password = document.getElementById('password').value;
      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      if (res.ok) {
        loggedIn = true;
        apiToken = prompt("Wpisz swój API_TOKEN (token autoryzacyjny):");
        if (!apiToken) {
          alert("Token jest wymagany!");
          return;
        }
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('panelDiv').style.display = 'block';
        await loadClients();
      } else {
        alert('Błędne hasło!');
      }
    }

    async function loadClients() {
      if (!loggedIn) return alert('Zaloguj się najpierw!');
      try {
        const res = await fetch('/clients');
        const clients = await res.json();
        const select = document.getElementById('clientsSelect');
        select.innerHTML = '<option value="">-- Wybierz klienta --</option>';
        clients.forEach(c => {
          const option = document.createElement('option');
          option.value = c;
          option.textContent = c;
          select.appendChild(option);
        });
        if (clients.length > 0 && !selectedClient) {
          selectedClient = clients[0];
          select.value = selectedClient;
        }
      } catch (e) {
        alert('Błąd ładowania klientów: ' + e.message);
      }
    }

    function selectClient() {
      const select = document.getElementById('clientsSelect');
      selectedClient = select.value;
      document.getElementById('resultOutput').textContent = 'Brak wyniku';
      // Ukryj eksplorator przy zmianie klienta
      document.getElementById('fileExplorer').style.display = 'none';
    }

    async function sendCommand() {
      if (!selectedClient) return alert('Wybierz klienta!');
      const command = document.getElementById('commandInput').value;
      if (!command) return alert('Wpisz komendę!');
      
      try {
        const res = await fetch('/command', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ client: selectedClient, command })
        });
        if (res.ok) {
          alert('Komenda wysłana!');
          document.getElementById('commandInput').value = '';
        } else {
          alert('Błąd wysyłania komendy: ' + res.statusText);
        }
      } catch (e) {
        alert('Błąd: ' + e.message);
      }
    }

    async function getResult() {
      if (!selectedClient) return alert('Wybierz klienta!');
      try {
        const res = await fetch(`/result?client=${encodeURIComponent(selectedClient)}`);
        if (res.status === 200) {
          const text = await res.text();
          document.getElementById('resultOutput').textContent = text;
        } else {
          document.getElementById('resultOutput').textContent = 'Brak wyniku';
        }
      } catch (e) {
        alert('Błąd: ' + e.message);
      }
    }

    // Eksplorator plików
    const fileListElem = document.getElementById('fileList');
    const fileContentElem = document.getElementById('fileContent');
    const currentPathElem = document.getElementById('currentPath');
    const loadingIndicator = document.getElementById('loadingIndicator');
    let currentPath = '';

    function showLoading(show) {
      loadingIndicator.style.display = show ? 'block' : 'none';
    }

    async function openExplorer() {
      if (!selectedClient) return alert("Wybierz klienta, zanim otworzysz eksplorator!");
      if (!apiToken) return alert("Brak tokena API!");
      document.getElementById('fileExplorer').style.display = 'block';
      await loadFiles('C:\\'); // startujemy z C:\ dla Windows
    }

    async function loadFiles(path) {
      showLoading(true);
      try {
        const res = await fetch(`/api/files?path=${encodeURIComponent(path)}&client=${encodeURIComponent(selectedClient)}`, {
          headers: { 'Authorization': `Bearer ${apiToken}` }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        currentPath = data.currentPath || data.path;
        currentPathElem.textContent = `Ścieżka: ${currentPath}`;
        fileListElem.innerHTML = '';

        // Przycisk powrotu do katalogu wyżej
        if (path !== 'C:\\' && path !== '') {
          const upLi = document.createElement('li');
          upLi.textContent = '.. (folder nadrzędny)';
          upLi.classList.add('up');
          upLi.onclick = () => {
            const pathParts = currentPath.split(/[\\/]/).filter(p => p.length > 0);
            if (pathParts.length > 1) {
              const upPath = pathParts.slice(0, -1).join('\\') + '\\';
              loadFiles(upPath);
            } else if (pathParts.length === 1) {
              loadFiles(pathParts[0] + '\\');
            }
          };
          fileListElem.appendChild(upLi);
        }

        // Lista plików i folderów
        if (data.files && Array.isArray(data.files)) {
          data.files.forEach(file => {
            const li = document.createElement('li');
            li.textContent = file.name;
            li.classList.add(file.isDirectory ? 'directory' : 'file');
            
            if (file.isDirectory) {
              li.onclick = () => {
                const newPath = currentPath.endsWith('\\') ? currentPath + file.name : currentPath + '\\' + file.name;
                loadFiles(newPath);
                fileContentElem.textContent = 'Wybierz plik, aby zobaczyć zawartość';
              };
            } else {
              // Dla plików - prawy klik pobiera, lewy klik pokazuje zawartość
              li.onclick = () => {
                const filePath = currentPath.endsWith('\\') ? currentPath + file.name : currentPath + '\\' + file.name;
                loadFileContent(filePath);
              };
              
              li.oncontextmenu = (e) => {
                e.preventDefault();
                const filePath = currentPath.endsWith('\\') ? currentPath + file.name : currentPath + '\\' + file.name;
                downloadFile(filePath);
              };
              
              // Dodaj przycisk pobierania
              const downloadBtn = document.createElement('span');
              downloadBtn.textContent = ' 💾';
              downloadBtn.style.float = 'right';
              downloadBtn.style.color = '#007bff';
              downloadBtn.style.cursor = 'pointer';
              downloadBtn.title = 'Pobierz plik';
              downloadBtn.onclick = (e) => {
                e.stopPropagation();
                const filePath = currentPath.endsWith('\\') ? currentPath + file.name : currentPath + '\\' + file.name;
                downloadFile(filePath);
              };
              li.appendChild(downloadBtn);
            }
            
            fileListElem.appendChild(li);
          });
        }

        if (!data.files || data.files.length === 0) {
          const emptyLi = document.createElement('li');
          emptyLi.textContent = '(pusty katalog)';
          emptyLi.style.fontStyle = 'italic';
          emptyLi.style.color = '#666';
          fileListElem.appendChild(emptyLi);
        }

      } catch (e) {
        alert('Błąd ładowania plików: ' + e.message);
        currentPathElem.textContent = 'Błąd ładowania';
      } finally {
        showLoading(false);
      }
    }

    async function loadFileContent(filePath) {
      fileContentElem.textContent = 'Ładowanie zawartości pliku...';
      try {
        const res = await fetch(`/api/file?path=${encodeURIComponent(filePath)}&client=${encodeURIComponent(selectedClient)}`, {
          headers: { 'Authorization': `Bearer ${apiToken}` }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        fileContentElem.textContent = data.content || '(plik pusty)';
      } catch (e) {
        fileContentElem.textContent = `Błąd ładowania pliku: ${e.message}`;
      }
    }

    async function downloadFile(filePath) {
      try {
        const filename = filePath.split(/[\\/]/).pop();
        const statusElem = document.getElementById('uploadStatus');
        statusElem.textContent = `Pobieranie ${filename}...`;
        
        const res = await fetch(`/api/download?path=${encodeURIComponent(filePath)}&client=${encodeURIComponent(selectedClient)}`, {
          headers: { 'Authorization': `Bearer ${apiToken}` }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        // Pobierz plik jako blob
        const blob = await res.blob();
        
        // Stwórz link do pobrania
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        statusElem.textContent = `✅ ${filename} został pobrany`;
        setTimeout(() => statusElem.textContent = '', 3000);
        
      } catch (e) {
        document.getElementById('uploadStatus').textContent = `❌ Błąd pobierania: ${e.message}`;
        setTimeout(() => document.getElementById('uploadStatus').textContent = '', 5000);
      }
    }

    async function uploadFile() {
      const fileInput = document.getElementById('fileUpload');
      const file = fileInput.files[0];
      
      if (!file) return;
      if (!selectedClient) return alert('Wybierz klienta!');
      if (!currentPath) return alert('Otwórz najpierw eksplorator plików!');
      
      const statusElem = document.getElementById('uploadStatus');
      statusElem.textContent = `Przesyłanie ${file.name}...`;
      
      try {
        // Konwertuj plik na base64
        const base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64String = reader.result.split(',')[1]; // usuń "data:type;base64," prefix
            resolve(base64String);
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        
        const res = await fetch('/api/upload', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiToken}` 
          },
          body: JSON.stringify({
            client: selectedClient,
            path: currentPath,
            filename: file.name,
            content: base64
          })
        });
        
        const result = await res.json();
        
        if (result.success) {
          statusElem.textContent = `✅ ${file.name} został przesłany`;
          // Odśwież listę plików
          await loadFiles(currentPath);
        } else {
          statusElem.textContent = `❌ Błąd: ${result.message}`;
        }
        
        // Wyczyść input
        fileInput.value = '';
        
        setTimeout(() => statusElem.textContent = '', 5000);
        
      } catch (e) {
        statusElem.textContent = `❌ Błąd przesyłania: ${e.message}`;
        setTimeout(() => statusElem.textContent = '', 5000);
      }
    }
  </script>
</body>
</html>
