import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

// Setup __dirname i dotenv (tylko lokalnie)
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
if (process.env.NODE_ENV !== 'production') dotenv.config();

const app = express();
const port = process.env.PORT || 3000;

const API_TOKEN = process.env.API_TOKEN;
const PANEL_PASSWORD = process.env.PANEL_PASSWORD;

if (!API_TOKEN || !PANEL_PASSWORD) {
  console.error("‚ùå Brak wymaganych zmiennych ≈õrodowiskowych (API_TOKEN lub PANEL_PASSWORD).");
  process.exit(1);
}

const clients = new Set();
const commands = {};
const results = {};

// Nowa struktura na listƒô plik√≥w od klienta:
// { [clientName]: { currentPath: string, files: [{name, type}] } }
const fileTrees = {};

// Struktura na zawarto≈õƒá plik√≥w
const fileContents = {};

app.use(cors());
app.use(express.json({ limit: '50mb' })); // Zwiƒôksz limit dla du≈ºych plik√≥w
app.use(express.urlencoded({ limit: '50mb', extended: true }));
app.use(express.static(path.join(__dirname, 'public')));

// Middleware autoryzujƒÖcy tylko dla klienta (C#)
function authMiddleware(req, res, next) {
  const token = req.headers['authorization'];
  if (token !== `Bearer ${API_TOKEN}`) {
    console.log('Authorization failed. Expected:', `Bearer ${API_TOKEN}`, 'Got:', token);
    return res.status(403).json({ success: false, message: 'Forbidden ‚Äì nieprawid≈Çowy token' });
  }
  next();
}

// ------------------------ PANEL ----------------------------

// Logowanie panelu (sprawdzanie has≈Ça)
app.post('/login', (req, res) => {
  const { password } = req.body;
  if (password === PANEL_PASSWORD) {
    res.json({ success: true });
  } else {
    res.status(403).json({ success: false });
  }
});

// Pobierz listƒô klient√≥w - bez tokena
app.get('/clients', (req, res) => {
  res.json(Array.from(clients));
});

// Pobierz wynik klienta
app.get('/result', (req, res) => {
  const client = req.query.client;
  if (!client) return res.status(400).send('Brakuje klienta');
  const r = results[client];
  if (r) {
    delete results[client];
    return res.send(r);
  }
  res.status(204).send();
});

// --------------------- KLIENT C# --------------------------

// Klient zg≈Çasza siƒô i dodaje do listy
app.post('/register', authMiddleware, (req, res) => {
  const { client } = req.body;
  if (!client) return res.status(400).send('Brakuje klienta');
  clients.add(client);
  console.log(`‚úÖ Klient zarejestrowany: ${client}`);
  res.sendStatus(200);
});

// Klient pobiera komendƒô
app.get('/command', authMiddleware, (req, res) => {
  const client = req.query.client;
  if (!client) return res.status(400).send('Brakuje klienta');
  const cmd = commands[client];
  if (cmd) {
    delete commands[client];
    console.log(`üì§ Wys≈Çano komendƒô do ${client}: ${cmd.substring(0, 100)}...`);
    return res.send(cmd);
  }
  res.status(204).send();
});

// Klient wysy≈Ça wynik
app.post('/result', authMiddleware, (req, res) => {
  const { client, result } = req.body;
  if (!client || !result) return res.status(400).send('Brakuje danych');
  results[client] = result;
  console.log(`üì• Otrzymano wynik od ${client}: ${result.substring(0, 100)}...`);
  res.sendStatus(200);
});

// Panel wysy≈Ça komendƒô do klienta
app.post('/command', (req, res) => {
  const { client, command } = req.body;
  if (!client || !command) return res.status(400).send('Brakuje danych');
  if (!clients.has(client)) return res.status(404).send('Klient nieznany');
  commands[client] = command;
  console.log(`üìù Zaplanowano komendƒô dla ${client}: ${command}`);
  res.sendStatus(200);
});

// ------------------- Eksplorator plik√≥w (od klienta) --------------------

// Klient wysy≈Ça listƒô plik√≥w i folder√≥w (dla podanej ≈õcie≈ºki)
app.post('/files', authMiddleware, (req, res) => {
  const { client, path, files } = req.body;
  if (!client || !path || !files) return res.status(400).send('Brakuje danych');

  // Zapisujemy dane
  fileTrees[client] = { currentPath: path, files };
  console.log(`üìÅ Otrzymano listƒô plik√≥w od ${client} dla ≈õcie≈ºki: ${path} (${files.length} element√≥w)`);

  res.sendStatus(200);
});

// Klient wysy≈Ça zawarto≈õƒá pliku
app.post('/file', authMiddleware, (req, res) => {
  const { client, path, content } = req.body;
  if (!client || !path || content === undefined) return res.status(400).send('Brakuje danych');

  // Zapisujemy zawarto≈õƒá pliku
  if (!fileContents[client]) {
    fileContents[client] = {};
  }
  fileContents[client][path] = content;
  console.log(`üìÑ Otrzymano zawarto≈õƒá pliku od ${client}: ${path} (${content.length} znak√≥w)`);

  res.sendStatus(200);
});

// Panel pobiera listƒô plik√≥w i folder√≥w dla klienta
app.get('/files', (req, res) => {
  const client = req.query.client;
  if (!client) return res.status(400).send('Brakuje klienta');

  const data = fileTrees[client];
  if (!data) return res.status(404).send('Brak danych o plikach');

  res.json(data);
});

// ------------------- API dla panelu (eksplorator plik√≥w) --------------------

// Panel ≈ºƒÖda listy plik√≥w - wysy≈Ça komendƒô do klienta
app.get('/api/files', authMiddleware, (req, res) => {
  const path = req.query.path;
  const client = req.query.client;
  
  if (!path || !client) return res.status(400).json({ success: false, message: 'Brakuje parametr√≥w' });
  if (!clients.has(client)) return res.status(404).json({ success: false, message: 'Klient nieznany' });

  console.log(`üìÇ Panel ≈ºƒÖda listy plik√≥w od ${client}: ${path}`);

  // Wy≈õlij komendƒô do klienta
  commands[client] = `listdir ${path}`;
  
  // Czekaj na odpowied≈∫ (w praktyce panel powinien pollowaƒá)
  const checkForData = async () => {
    for (let i = 0; i < 30; i++) { // maksymalnie 15 sekund oczekiwania
      await new Promise(resolve => setTimeout(resolve, 500));
      const data = fileTrees[client];
      if (data && data.currentPath === path) {
        console.log(`‚úÖ Zwr√≥cono listƒô plik√≥w dla ${client}: ${path}`);
        return res.json(data);
      }
    }
    console.log(`‚è∞ Timeout dla listy plik√≥w ${client}: ${path}`);
    res.status(408).json({ success: false, message: 'Timeout - brak odpowiedzi od klienta' });
  };

  checkForData();
});

// Panel ≈ºƒÖda zawarto≈õci pliku - wysy≈Ça komendƒô do klienta
app.get('/api/file', authMiddleware, (req, res) => {
  const path = req.query.path;
  const client = req.query.client;
  
  if (!path || !client) return res.status(400).json({ success: false, message: 'Brakuje parametr√≥w' });
  if (!clients.has(client)) return res.status(404).json({ success: false, message: 'Klient nieznany' });

  console.log(`üìñ Panel ≈ºƒÖda zawarto≈õci pliku od ${client}: ${path}`);

  // Wy≈õlij komendƒô do klienta
  commands[client] = `readfile ${path}`;
  
  // Czekaj na odpowied≈∫
  const checkForData = async () => {
    for (let i = 0; i < 30; i++) { // maksymalnie 15 sekund oczekiwania
      await new Promise(resolve => setTimeout(resolve, 500));
      if (fileContents[client] && fileContents[client][path] !== undefined) {
        const content = fileContents[client][path];
        // Usu≈Ñ po pobraniu, aby nie za≈õmiecaƒá pamiƒôci
        delete fileContents[client][path];
        console.log(`‚úÖ Zwr√≥cono zawarto≈õƒá pliku dla ${client}: ${path}`);
        return res.json({ content });
      }
    }
    console.log(`‚è∞ Timeout dla zawarto≈õci pliku ${client}: ${path}`);
    res.status(408).json({ success: false, message: 'Timeout - brak odpowiedzi od klienta' });
  };

  checkForData();
});

// Panel pobiera plik (download) - base64 encoded
app.get('/api/download', authMiddleware, (req, res) => {
  const path = req.query.path;
  const client = req.query.client;
  
  if (!path || !client) return res.status(400).json({ success: false, message: 'Brakuje parametr√≥w' });
  if (!clients.has(client)) return res.status(404).json({ success: false, message: 'Klient nieznany' });

  console.log(`üíæ Panel ≈ºƒÖda pobrania pliku od ${client}: ${path}`);

  // Wy≈õlij komendƒô do klienta
  commands[client] = `downloadfile ${path}`;
  
  // Czekaj na odpowied≈∫
  const checkForData = async () => {
    for (let i = 0; i < 60; i++) { // maksymalnie 30 sekund dla du≈ºych plik√≥w
      await new Promise(resolve => setTimeout(resolve, 500));
      if (fileContents[client] && fileContents[client][path] !== undefined) {
        const base64Content = fileContents[client][path];
        // Usu≈Ñ po pobraniu
        delete fileContents[client][path];
        
        try {
          // Konwertuj base64 na buffer
          const buffer = Buffer.from(base64Content, 'base64');
          const filename = path.split(/[\\/]/).pop();
          
          console.log(`‚úÖ Plik ${filename} gotowy do pobrania (${buffer.length} bytes)`);
          
          res.setHeader('Content-Disposition', `attachment; filename="${filename}"`);
          res.setHeader('Content-Type', 'application/octet-stream');
          return res.send(buffer);
        } catch (e) {
          console.error(`‚ùå B≈ÇƒÖd dekodowania pliku ${path}:`, e.message);
          return res.status(500).json({ success: false, message: 'B≈ÇƒÖd dekodowania pliku' });
        }
      }
    }
    console.log(`‚è∞ Timeout dla pobierania pliku ${client}: ${path}`);
    res.status(408).json({ success: false, message: 'Timeout - brak odpowiedzi od klienta' });
  };

  checkForData();
});

// Panel wysy≈Ça plik (upload) - POPRAWIONA WERSJA
app.post('/api/upload', authMiddleware, (req, res) => {
  console.log('üì§ Upload request received');
  console.log('Headers authorization:', req.headers['authorization'] ? 'Present' : 'Missing');
  console.log('Body keys:', Object.keys(req.body));
  
  const { client, path, content, filename } = req.body;
  
  if (!client || !path || !content || !filename) {
    console.log('‚ùå Missing parameters:', { 
      client: !!client, 
      path: !!path, 
      content: !!content, 
      filename: !!filename 
    });
    return res.status(400).json({ 
      success: false, 
      message: 'Brakuje parametr√≥w (client, path, content, filename)' 
    });
  }
  
  if (!clients.has(client)) {
    console.log('‚ùå Unknown client:', client);
    console.log('Available clients:', Array.from(clients));
    return res.status(404).json({ 
      success: false, 
      message: `Klient nieznany: ${client}` 
    });
  }

  console.log(`üì§ Uploading file ${filename} to client ${client} at path ${path}`);
  console.log(`Content size: ${content.length} characters`);
  
  // Wy≈õlij komendƒô do klienta z zawarto≈õciƒÖ pliku (base64)
  const fullPath = path.endsWith('\\') ? path + filename : path + '\\' + filename;
  commands[client] = `uploadfile ${fullPath} ${content}`;
  
  console.log(`üìù Command sent to client: uploadfile ${fullPath} [${content.length} chars base64]`);
  
  // Czekaj na potwierdzenie
  const checkForResult = async () => {
    for (let i = 0; i < 60; i++) { // maksymalnie 30 sekund
      await new Promise(resolve => setTimeout(resolve, 500));
      const result = results[client];
      if (result !== undefined) {
        console.log(`üì• Received result from client ${client}:`, result);
        delete results[client];
        if (result.includes('SUCCESS')) {
          console.log(`‚úÖ Upload successful for ${filename}`);
          return res.json({ success: true, message: 'Plik zosta≈Ç przes≈Çany' });
        } else {
          console.log(`‚ùå Upload failed for ${filename}:`, result);
          return res.status(400).json({ success: false, message: result });
        }
      }
    }
    console.log(`‚è∞ Upload timeout for client ${client}, file ${filename}`);
    res.status(408).json({ success: false, message: 'Timeout - brak odpowiedzi od klienta' });
  };

  checkForResult();
});

// Error handling middleware
app.use((error, req, res, next) => {
  console.error('‚ùå Server error:', error);
  res.status(500).json({ success: false, message: 'B≈ÇƒÖd serwera' });
});

app.listen(port, () => {
  console.log(`‚úÖ Serwer dzia≈Ça na porcie ${port}`);
  console.log(`üîë API_TOKEN: ${API_TOKEN ? 'Skonfigurowany' : 'BRAK'}`);
  console.log(`üîí PANEL_PASSWORD: ${PANEL_PASSWORD ? 'Skonfigurowany' : 'BRAK'}`);
});
